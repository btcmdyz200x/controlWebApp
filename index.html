<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE 翅膀控制器 - 调速版</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 确保页面主体居中且美观 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 480px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4F46E5;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 控制面板容器 -->
    <div class="container bg-white shadow-2xl rounded-xl p-6 md:p-8 w-full border border-indigo-100">
        
        <!-- 修正后的标题 -->
        <h1 class="3xl font-bold text-indigo-700 mb-2 text-center">BLE 翅膀控制器</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">可变速度范围：360°/s 到 700°/s</p>

        <!-- 状态区域 -->
        <div id="status-card" class="bg-gray-100 p-4 rounded-lg mb-6 flex justify-between items-center transition duration-300">
            <span id="status-text" class="text-gray-600 font-semibold">状态: 未连接</span>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 shadow-inner"></div>
        </div>

        <!-- 连接按钮 -->
        <button id="connect-btn" onclick="connectBLE()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] shadow-lg mb-8">
            连接 ESP32-C3 翅膀
        </button>

        <!-- 控制按钮区域 -->
        <div id="control-panel" class="space-y-4 opacity-30 pointer-events-none transition duration-500">
            <h2 class="text-xl font-semibold text-gray-700 pt-4 border-t border-gray-200 mb-4">速度与动作控制</h2>

            <!-- 速度滑块 -->
            <div class="speed-control bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="speed-slider" class="block text-lg font-medium text-gray-700 mb-2">
                    当前转速: <span id="speed-value" class="text-indigo-600 font-bold">360</span> 度/秒
                </label>
                <input type="range" id="speed-slider" min="360" max="700" value="360" 
                       oninput="document.getElementById('speed-value').textContent = this.value; sendSpeed(this.value);" 
                       onchange="sendSpeed(this.value);"
                       class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>360°/s (慢)</span>
                    <span>700°/s (快)</span>
                </div>
            </div>

            <!-- 动作按钮 -->
            <div class="grid grid-cols-3 gap-3 pt-4">
                <!-- 开始煽动 (A) -->
                <button onclick="sendCommand('A')" class="col-span-1 bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md text-sm">
                    开始煽动
                </button>

                <!-- 停止/水平复位 (C) -->
                <button onclick="sendCommand('C')" class="col-span-1 bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md text-sm">
                    停止/水平 (90°)
                </button>

                <!-- 竖直向上 (T) -->
                <button onclick="sendCommand('T')" class="col-span-1 bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-md text-sm">
                    竖直向上 (0°)
                </button>
            </div>
            
        </div>
    </div>

    <script>
        // --- BLE UUID 配置 (与 C++ 代码匹配的小写 UUID) ---
        const DEVICE_NAME = 'ESP32C3_BLE_Servo';
        const SERVICE_UUID = '4fafc201-1fb5-40ca-984a-9a4b1b9c568a'; 
        const CONTROL_CHAR_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8'; 

        let controlCharacteristic = null;
        let bleDevice = null;
        
        // --- 翅膀状态跟踪 ---
        let wingState = 'horizontal'; // 'horizontal' | 'upward' | 'swinging'
        
        // --- DOM 元素引用 ---
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const connectBtn = document.getElementById('connect-btn');
        const controlPanel = document.getElementById('control-panel');
        // AI相关的DOM引用已移除
        const speedSlider = document.getElementById('speed-slider');

        // --- UI 更新函数 ---
        function updateStatus(text, isConnected) {
            statusText.textContent = `状态: ${text}`;
            if (isConnected) {
                statusIndicator.classList.remove('bg-red-500');
                statusIndicator.classList.add('bg-green-500');
                controlPanel.classList.remove('opacity-30', 'pointer-events-none');
                connectBtn.textContent = '设备已连接';
                connectBtn.disabled = true;
            } else {
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                controlPanel.classList.add('opacity-30', 'pointer-events-none');
                connectBtn.textContent = '连接 ESP32-C3 翅膀';
                connectBtn.disabled = false;
            }
        }

        // --- BLE 连接逻辑 ---
        async function connectBLE() {
            if (!navigator.bluetooth) {
                updateStatus('浏览器不支持 Web Bluetooth API。请使用 Chrome/Edge 并确保在 HTTPS 环境下运行。', false);
                return;
            }

            updateStatus('正在扫描设备...', false);
            connectBtn.disabled = true;

            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID] 
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                updateStatus('正在连接 GATT 服务器...', false);
                const server = await bleDevice.gatt.connect();

                updateStatus('正在获取服务...', false);
                const service = await server.getPrimaryService(SERVICE_UUID);

                updateStatus('正在获取特性...', false);
                controlCharacteristic = await service.getCharacteristic(CONTROL_CHAR_UUID);
                
                updateStatus('已连接', true);

                // --- 确保连接成功后立即发送滑块上的初始速度值 ---
                const initialSpeed = speedSlider.value;
                await sendSpeed(initialSpeed);
                // -------------------------------------------------------------

            } catch (error) {
                console.error('BLE 连接或操作失败:', error);
                updateStatus(`连接失败: ${error.message}`, false); 
                connectBtn.disabled = false;
                if (bleDevice) {
                    bleDevice.removeEventListener('gattserverdisconnected', onDisconnected);
                    bleDevice = null;
                }
            }
        }

        // --- BLE 断开连接回调 ---
        function onDisconnected(event) {
            const device = event.target;
            console.log(`设备 ${device.name} 已断开连接。`);
            updateStatus('已断开连接', false);
            controlCharacteristic = null;
            bleDevice = null;
            // 重置 Web App 状态
            wingState = 'horizontal'; 
        }

        // --- 发送命令给 ESP32 (更新状态跟踪) ---
        async function sendCommand(command) {
            if (!controlCharacteristic) {
                console.warn('未连接到特性。请先连接设备。');
                updateStatus('请先连接设备', false);
                return;
            }
            
            // 跟踪状态
            if (command === 'A') {
                wingState = 'swinging';
            } else if (command === 'C') {
                wingState = 'horizontal';
            } else if (command === 'T') {
                wingState = 'upward';
            }

            try {
                // 将字符串命令转换为 Uint8Array
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                
                await controlCharacteristic.writeValue(data);
                console.log(`发送指令成功: ${command}`);

            } catch (error) {
                console.error('写入特性失败:', error);
                updateStatus('发送指令失败', false);
            }
        }
        
        // --- 发送速度值给 ESP32 ---
        async function sendSpeed(speedValue) {
            if (!controlCharacteristic) {
                // 如果未连接，则不发送速度命令，防止出现错误
                return;
            }
            
            try {
                // 速度值作为字符串发送，例如 "530"
                const encoder = new TextEncoder();
                const data = encoder.encode(String(speedValue));
                
                await controlCharacteristic.writeValue(data);
                console.log(`发送速度成功: ${speedValue} deg/s`);

            } catch (error) {
                console.error('写入速度失败:', error);
            }
        }
        
        // AI相关的函数已移除

        // 页面加载时检查 BLE 支持
        window.onload = () => {
             if (navigator.bluetooth && window.isSecureContext) {
                 updateStatus('未连接', false);
             } else {
                 updateStatus('Web Bluetooth 不可用或环境不安全 (需要 HTTPS)', false);
                 connectBtn.disabled = true;
             }
        };

    </script>
</body>
</html>
