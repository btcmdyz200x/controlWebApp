<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE 翅膀控制器 - 振幅频率版</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 确保页面主体居中且美观 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 480px;
        }
        /* 美化滑块的拖动块 */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4F46E5;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 控制面板容器 -->
    <div class="container bg-white shadow-2xl rounded-xl p-6 md:p-8 w-full border border-indigo-100">
        
        <!-- 修正后的标题 -->
        <h1 class="3xl font-bold text-indigo-700 mb-2 text-center">BLE 翅膀控制器</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">振幅(°)/频率(Hz) 控制模式</p>

        <!-- 状态区域 -->
        <div id="status-card" class="bg-gray-100 p-4 rounded-lg mb-6 flex justify-between items-center transition duration-300">
            <span id="status-text" class="text-gray-600 font-semibold">状态: 未连接</span>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 shadow-inner"></div>
        </div>

        <!-- 连接按钮 -->
        <button id="connect-btn" onclick="connectBLE()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] shadow-lg mb-8">
            连接 ESP32-C3 翅膀
        </button>

        <!-- 控制面板 (连接后启用) -->
        <div id="control-panel" class="space-y-6 opacity-30 pointer-events-none transition duration-500">
            <h2 class="text-xl font-semibold text-gray-700 pt-4 border-t border-gray-200 mb-4">参数调整</h2>

            <!-- 1. 振幅滑块 (Amplitude) -->
            <div class="amp-control bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="amplitude-slider" class="block text-lg font-medium text-gray-700 mb-2">
                    当前振幅 (A): <span id="amplitude-value" class="text-indigo-600 font-bold">30</span> 度 (0°~60°)
                </label>
                <!-- 范围 0 到 60 度 -->
                <input type="range" id="amplitude-slider" min="0" max="60" value="30" 
                       oninput="updateAmplitude(this.value);" 
                       onchange="sendCombinedCommand();"
                       class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0° (静止/水平)</span>
                    <span>60° (最大向上)</span>
                </div>
            </div>

            <!-- 2. 频率滑块 (Frequency) -->
            <div class="freq-control bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="frequency-slider" class="block text-lg font-medium text-gray-700 mb-2">
                    当前频率 (F): <span id="frequency-value" class="text-indigo-600 font-bold">5.0</span> Hz (1~10 Hz)
                </label>
                <!-- 范围 10 到 100，对应 1.0Hz 到 10.0Hz -->
                <input type="range" id="frequency-slider" min="10" max="100" value="50" 
                       oninput="updateFrequency(this.value);" 
                       onchange="sendCombinedCommand();"
                       class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer range-lg">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>1.0 Hz (慢)</span>
                    <span>10.0 Hz (快)</span>
                </div>
            </div>


            <!-- 动作按钮 -->
            <div class="grid grid-cols-3 gap-3 pt-4">
                <!-- 开始煽动 (A) -->
                <button onclick="sendCommand('A')" class="col-span-1 bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md text-sm">
                    开始煽动
                </button>

                <!-- 停止/水平复位 (C) -->
                <button onclick="sendCommand('C')" class="col-span-1 bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md text-sm">
                    停止/水平 (90°)
                </button>

                <!-- 竖直向上 (T) -->
                <button onclick="sendCommand('T')" class="col-span-1 bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-md text-sm">
                    竖直向上 (0°)
                </button>
            </div>
            
        </div>
    </div>

    <script>
        // --- BLE UUID 配置 (与 C++ 代码匹配的小写 UUID) ---
        const DEVICE_NAME = 'ESP32C3_BLE_Servo';
        const SERVICE_UUID = '4fafc201-1fb5-40ca-984a-9a4b1b9c568a'; 
        const CONTROL_CHAR_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8'; 

        let controlCharacteristic = null;
        let bleDevice = null;
        
        // --- 状态跟踪 ---
        let currentAmplitude = 30; // 默认值 30°
        let currentFrequency = 5.0; // 默认值 5.0 Hz
        
        // --- DOM 元素引用 ---
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const connectBtn = document.getElementById('connect-btn');
        const controlPanel = document.getElementById('control-panel');
        
        const amplitudeSlider = document.getElementById('amplitude-slider');
        const frequencySlider = document.getElementById('frequency-slider');
        const amplitudeValue = document.getElementById('amplitude-value');
        const frequencyValue = document.getElementById('frequency-value');


        // --- UI 更新函数 ---
        function updateStatus(text, isConnected) {
            statusText.textContent = `状态: ${text}`;
            if (isConnected) {
                statusIndicator.classList.remove('bg-red-500');
                statusIndicator.classList.add('bg-green-500');
                controlPanel.classList.remove('opacity-30', 'pointer-events-none');
                connectBtn.textContent = '设备已连接';
                connectBtn.disabled = true;
            } else {
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                controlPanel.classList.add('opacity-30', 'pointer-events-none');
                connectBtn.textContent = '连接 ESP32-C3 翅膀';
                connectBtn.disabled = false;
            }
        }

        // --- 滑块值更新函数 (振幅) ---
        function updateAmplitude(value) {
            currentAmplitude = parseInt(value, 10);
            amplitudeValue.textContent = currentAmplitude;
        }

        // --- 滑块值更新函数 (频率) ---
        function updateFrequency(value) {
            // 滑块范围 10-100，表示 1.0Hz - 10.0Hz
            currentFrequency = (parseInt(value, 10) / 10).toFixed(1);
            frequencyValue.textContent = currentFrequency;
        }
        
        // --- BLE 连接逻辑 ---
        async function connectBLE() {
            if (!navigator.bluetooth) {
                updateStatus('浏览器不支持 Web Bluetooth API。请使用 Chrome/Edge 并确保在 HTTPS 环境下运行。', false);
                return;
            }

            updateStatus('正在扫描设备...', false);
            connectBtn.disabled = true;

            try {
                // 1. 请求设备
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID] 
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                updateStatus('正在连接 GATT 服务器...', false);
                const server = await bleDevice.gatt.connect();

                updateStatus('正在获取服务...', false);
                const service = await server.getPrimaryService(SERVICE_UUID);

                updateStatus('正在获取特性...', false);
                controlCharacteristic = await service.getCharacteristic(CONTROL_CHAR_UUID);
                
                updateStatus('已连接', true);

                // --- 确保连接成功后立即发送初始参数值 ---
                sendCombinedCommand();
                // -------------------------------------------------------------

            } catch (error) {
                // 专门处理用户取消或找不到设备的错误
                if (error.name === 'NotFoundError') {
                    updateStatus(`连接失败: 未找到设备 (${DEVICE_NAME})，请确保ESP32已通电并正在广播。`, false); 
                } else if (error.name === 'NotAllowedError') {
                    updateStatus('连接失败: 权限被拒绝或设备已配对。', false); 
                } else {
                    console.error('BLE 连接或操作失败:', error);
                    updateStatus(`连接失败: ${error.message}`, false); 
                }
                
                connectBtn.disabled = false;
                if (bleDevice) {
                    bleDevice.removeEventListener('gattserverdisconnected', onDisconnected);
                    bleDevice = null;
                }
            }
        }

        // --- BLE 断开连接回调 ---
        function onDisconnected(event) {
            const device = event.target;
            console.log(`设备 ${device.name} 已断开连接。`);
            updateStatus('已断开连接', false);
            controlCharacteristic = null;
            bleDevice = null;
        }
        
        // --- 发送组合命令 (参数) ---
        async function sendCombinedCommand() {
            if (!controlCharacteristic) {
                console.warn('未连接到特性。参数未发送。');
                return;
            }
            
            // 组合命令格式: A<amplitude>,F<frequency> (例如: A30,F5.0)
            const combinedCommand = `A${currentAmplitude},F${currentFrequency}`;
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(combinedCommand);
                
                // 使用指数退避重试机制发送数据
                await retryWrite(controlCharacteristic, data, combinedCommand);

            } catch (error) {
                console.error('写入参数失败:', error);
            }
        }


        // --- 发送命令给 ESP32 (动作) ---
        async function sendCommand(command) {
            if (!controlCharacteristic) {
                console.warn('未连接到特性。请先连接设备。');
                updateStatus('请先连接设备', false);
                return;
            }

            try {
                // 动作命令作为单个字符发送
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                
                // 使用指数退避重试机制发送数据
                await retryWrite(controlCharacteristic, data, command);

            } catch (error) {
                console.error('写入特性失败:', error);
                updateStatus('发送指令失败', false);
            }
        }

        // --- 指数退避重试机制 ---
        async function retryWrite(characteristic, data, command) {
            const maxRetries = 3;
            let delay = 100; // 初始延迟 100ms
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    await characteristic.writeValue(data);
                    console.log(`发送指令成功: ${command}`);
                    return; // 成功则返回
                } catch (error) {
                    if (i === maxRetries - 1) {
                        // 最后一次尝试失败，抛出错误
                        throw error;
                    }
                    // 等待指数退避的时间
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // 延迟加倍
                }
            }
        }
        

        // 页面加载时初始化滑块值并检查 BLE 支持
        window.onload = () => {
             // 初始化滑块显示值
             updateAmplitude(amplitudeSlider.value);
             updateFrequency(frequencySlider.value);
             
             // 检查是否在安全上下文 (HTTPS) 中
             if (navigator.bluetooth && window.isSecureContext) {
                 updateStatus('未连接', false);
             } else {
                 updateStatus('Web Bluetooth 不可用或环境不安全 (需要 HTTPS)', false);
                 connectBtn.disabled = true;
             }
        };

    </script>
</body>
</html>
